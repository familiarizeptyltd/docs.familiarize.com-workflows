name: Daily Content Generation

# Generates content from pre-scheduled topic queue
# Multi-tenant architecture: Queue stored in content repo

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
    
  workflow_dispatch:
    inputs:
      execution_mode:
        description: 'Execution mode'
        required: true
        default: 'manual'
        type: choice
        options:
          - manual
          - scheduled
          - test
          - dry-run
      num_topics:
        description: 'Number of topics (0 = use daily quota from config)'
        required: false
        default: '0'
        type: string

jobs:
  generate-content:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      TENANT_ID: docs.familiarize.com

    steps:
      # Step 1: Checkout agent repository
      - name: Checkout agent repository
        uses: actions/checkout@v4
        with:
          repository: salmansarfacz/familiarizeWebsiteManagerAppsScript2App
          ref: main
          path: agent-repo
          token: ${{ secrets.FAMILIARIZEWEBSITEMANAGERAPPSSCRIPT2APP_AGENT_TOKEN || secrets.GH_PAT }}

      # Step 2: Checkout content repository
      - name: Checkout content repository
        uses: actions/checkout@v4
        with:
          repository: familiarizeptyltd/docs.familiarize.com
          ref: agentMigration
          path: content-repo
          token: ${{ secrets.REPO_TOKEN || secrets.GH_PAT }}
          fetch-depth: 1

      # Step 3: Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: agent-repo/familiarize-agent/requirements.txt

      # Step 4: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r agent-repo/familiarize-agent/requirements.txt

      # Step 5: Create necessary directories
      - name: Create necessary directories
        run: |
          mkdir -p agent-repo/familiarize-agent/logs
          mkdir -p content-repo/.agent-data/topic_queue
          mkdir -p content-repo/.agent-data/embeddings

      # Step 6: Setup Google credentials
      - name: Setup Google credentials
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > /tmp/google-credentials.json
          chmod 600 /tmp/google-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google-credentials.json" >> $GITHUB_ENV

      # Step 7: Clear Python cache
      - name: Clear Python cache
        working-directory: agent-repo/familiarize-agent
        run: |
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true

      # Step 8: Check if queue exists
      - name: Check topic queue
        id: check_queue
        run: |
          if [ -d "content-repo/.agent-data/topic_queue" ] && [ "$(ls -A content-repo/.agent-data/topic_queue)" ]; then
            echo "queue_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Topic queue found in content repository"
            ls -lh content-repo/.agent-data/topic_queue/
          else
            echo "queue_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Topic queue not found - run Monthly Queue Generation first"
          fi

      # Step 9: Run daily workflow
      - name: Generate daily content
        if: steps.check_queue.outputs.queue_exists == 'true'
        env:
          # Multi-tenant configuration
          TENANT_ID: docs.familiarize.com
          TARGET_REPO_PATH: ${{ github.workspace }}/content-repo
          
          # GitHub configuration
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN || secrets.GH_PAT }}
          GITHUB_AGENT_TOKEN: ${{ secrets.FAMILIARIZEWEBSITEMANAGERAPPSSCRIPT2APP_AGENT_TOKEN || '' }}
          GITHUB_OWNER: familiarizeptyltd
          GITHUB_REPO: docs.familiarize.com
          GITHUB_BRANCH: agentMigration
          GITHUB_AGENT_OWNER: salmansarfacz
          GITHUB_AGENT_REPO: familiarizeWebsiteManagerAppsScript2App
          GITHUB_AGENT_BRANCH: main
          
          # API Keys
          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          PROFESSIONALIZE_BASE_URL: https://llm.professionalize.com/v1
          PROFESSIONALIZE_LLM_MODEL: gpt-oss
          PROFESSIONALIZE_EMBEDDING_MODEL: qwen3-embedding-8b
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Google Services
          GOOGLE_CUSTOM_SEARCH_API_KEY: ${{ secrets.GOOGLE_CUSTOM_SEARCH_API_KEY }}
          CUSTOM_SEARCH_ENGINE_ID: ${{ secrets.CUSTOM_SEARCH_ENGINE_ID }}
          GOOGLE_ADS_CUSTOMER_ID: ${{ secrets.GOOGLE_ADS_CUSTOMER_ID }}
          GOOGLE_ADS_DEVELOPER_TOKEN: ${{ secrets.GOOGLE_ADS_DEVELOPER_TOKEN }}
          
          # LLM Provider
          LLM_PROVIDER: professionalize
          EMBEDDING_PROVIDER: professionalize
          EMBEDDING_DIMENSIONS: 1536
          
          # Workflow configuration
          EXECUTION_MODE: ${{ github.event.inputs.execution_mode || 'scheduled' }}
          DAILY_CONTENT_QUOTA: ${{ github.event.inputs.num_topics || '7' }}
          CONTENT_OUTPUT_DIR: ${{ github.workspace }}/content-repo/content/en/Glossary
          
        working-directory: agent-repo/familiarize-agent
        run: |
          echo "========================================================================"
          echo "Daily Content Generation - Multi-Tenant Architecture"
          echo "========================================================================"
          echo ""
          echo "Configuration:"
          echo "  - Tenant: ${TENANT_ID}"
          echo "  - Execution Mode: ${EXECUTION_MODE}"
          echo "  - Daily Quota: ${DAILY_CONTENT_QUOTA}"
          echo "  - Queue Location: ${TARGET_REPO_PATH}/.agent-data/topic_queue/"
          echo "  - Content Output: ${CONTENT_OUTPUT_DIR}"
          echo ""
          
          # Run daily workflow with tenant parameter
          python src/scripts/daily_morning_workflow.py --tenant docs.familiarize.com

      # Step 10: Queue not found - skip
      - name: Queue not found
        if: steps.check_queue.outputs.queue_exists == 'false'
        run: |
          echo "‚ö†Ô∏è  Topic queue not found in content repository"
          echo ""
          echo "Please run the 'Monthly Queue Generation' workflow first to populate the queue."
          echo ""
          echo "Expected location: content-repo/.agent-data/topic_queue/"
          exit 0

      # Step 11: Commit content and queue updates
      - name: Commit changes to content repository
        if: steps.check_queue.outputs.queue_exists == 'true'
        working-directory: content-repo
        run: |
          git config user.name "Familiarize Agent"
          git config user.email "agent@familiarize.com"

          # Add generated content
          git add content/

          # Add queue status updates (PENDING ‚Üí COMPLETED)
          git add .agent-data/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Daily content generation $(date +'%Y-%m-%d')
            
            Tenant: docs.familiarize.com
            Mode: ${{ github.event.inputs.execution_mode || 'scheduled' }}
            
            Updates:
            - Generated content in content/en/Glossary/
            - Updated topic queue status in .agent-data/topic_queue/
            
            Generated: $(date +'%Y-%m-%d %H:%M UTC')
            "
            
            git push
            
            echo "‚úÖ Content and queue updates committed successfully"
          fi

      # Step 12: Upload artifacts
      - name: Upload execution artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-report-${{ github.run_number }}
          path: |
            agent-repo/familiarize-agent/logs/
          retention-days: 30

      # Step 13: Generate summary
      - name: Generate summary
        if: always()
        run: |
          echo "## üìù Daily Content Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant**: \`docs.familiarize.com\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Mode**: ${{ github.event.inputs.execution_mode || 'scheduled' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Repository**: familiarizeptyltd/docs.familiarize.com (branch: agentMigration)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- **Queue Source**: \`.agent-data/topic_queue/\` (content repo)" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Output**: \`content/en/Glossary/\` (content repo)" >> $GITHUB_STEP_SUMMARY
          echo "- **Queue Updates**: Committed to content repo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f agent-repo/familiarize-agent/logs/agent.log ]; then
            echo "### Execution Metrics" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 50 agent-repo/familiarize-agent/logs/agent.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      # Step 14: Notify on failure
      - name: Notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚ùå Daily Content Generation Failed'
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Familiarize Agent <${{ secrets.SMTP_USERNAME }}>
          body: |
            üö® Daily Content Generation Failed

            Tenant: docs.familiarize.com
            Content Repository: familiarizeptyltd/docs.familiarize.com
            Execution Mode: ${{ github.event.inputs.execution_mode || 'scheduled' }}

            Check logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        continue-on-error: true

      # Step 15: Notify on success
      - name: Notify on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚úÖ Daily Content Generated Successfully'
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Familiarize Agent <${{ secrets.SMTP_USERNAME }}>
          body: |
            ‚úÖ Daily Content Generation Completed

            Tenant: docs.familiarize.com
            Execution Mode: ${{ github.event.inputs.execution_mode || 'scheduled' }}
            
            Updates:
            - Content generated in content/en/Glossary/
            - Queue status updated in .agent-data/topic_queue/
            
            View content:
            https://github.com/familiarizeptyltd/docs.familiarize.com/tree/agentMigration/content
            
            View logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        continue-on-error: true
