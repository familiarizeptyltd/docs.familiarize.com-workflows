name: docs.familiarize.com (Build & Deploy)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["docs.familiarize.com (Translate)"]
    types: [completed]

jobs:
  build:
    name: Build and Deploy Job
    runs-on: ubuntu-latest
    timeout-minutes: 180
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout workflows repo
        uses: actions/checkout@v4

      - name: Checkout docs.familiarize.com (private)
        uses: actions/checkout@v4
        with:
          repository: familiarizeptyltd/docs.familiarize.com
          path: docs_repo
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Generate only static/llms.txt
      - name: Generate llms.txt
        working-directory: docs_repo
        env:
          BASE_URL: "https://docs.familiarize.com"   # optional; remove to use relative links
          MAX_LINKS: "5000"                           # optional cap
          VALIDATE_HTTP: "0"                         # 0|1  (default 0 = off) - 404 checking
          VALIDATE_MAX: "800"                        # cap validated URLs
          VALIDATE_TIMEOUT: "3"                      # seconds per request
          ALLOW_EXTERNAL: "0"                        # skip other domains
          STRICT_URL: "0"                            # respect front-matter "url:"
        run: |
          python3 scripts/generate_llms.py

      # Commit only llms.txt if changed
      - name: Commit llms.txt (if changed)
        working-directory: docs_repo
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [[ -n "$(git status --porcelain static/llms.txt)" ]]; then
            git add static/llms.txt
            git commit -m "Updated llms.txt [CI]"
            git push origin HEAD:main
            echo "Pushed static/llms.txt to private repo."
          else
            echo "No changes in static/llms.txt; skipping commit."
          fi      

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.123.8"

      - name: Build Hugo (watchdog + stack dump)
        working-directory: docs_repo
        shell: bash
        run: |
          set -euo pipefail
      
          LOG=hugo.log
          : > "$LOG"
      
          # keep-alive pings (so Actions doesn't think it's frozen)
          ( while true; do echo "[$(date)] build alive"; sleep 900; done ) &
          KEEPALIVE_PID=$!
      
          # run hugo and capture output
          stdbuf -oL -eL hugo --logLevel info --printMemoryUsage 2>&1 | tee -a "$LOG" &
          HUGO_PID=$!
      
          echo "Hugo PID: $HUGO_PID"
      
          # Track last meaningful progress line
          LAST_TS=$(date +%s)
      
          # If Hugo prints "step render substep", treat as progress
          ( tail -n 0 -F "$LOG" | while read -r line; do
              if echo "$line" | grep -q "step render substep"; then
                LAST_TS=$(date +%s)
              fi
            done
          ) &
          TAIL_PID=$!
      
          # Watchdog loop: if no progress for 20 minutes, dump stacks and fail
          while kill -0 "$HUGO_PID" 2>/dev/null; do
            sleep 60
            NOW=$(date +%s)
            IDLE=$((NOW - LAST_TS))
      
            if [ "$IDLE" -ge $((20*60)) ]; then
              echo "No render-step progress for 20 minutes. Dumping goroutines (SIGQUIT)..."
              kill -QUIT "$HUGO_PID" || true
              sleep 8
              echo "Stopping Hugo after stack dump..."
              kill -TERM "$HUGO_PID" || true
              sleep 5
              kill -KILL "$HUGO_PID" || true
              exit 1
            fi
          done
      
          # Cleanup
          kill "$TAIL_PID" 2>/dev/null || true
          wait "$HUGO_PID"
          HUGO_EXIT=$?
      
          kill "$KEEPALIVE_PID" 2>/dev/null || true
      
          echo "Hugo finished with exit code $HUGO_EXIT"
          exit "$HUGO_EXIT"


      - name: Deploy (hugo deploy)
        working-directory: docs_repo
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.FAMILIARIZE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.FAMILIARIZE_SECRET_ACCESS }}
        run: |
          hugo deploy --maxDeletes -1

      - name: Invalidate CloudFront Cache
        uses: chetan/invalidate-cloudfront-action@master
        env:
          DISTRIBUTION: ${{ secrets.AWS_DOCS_FAMILIARIZE_DISTRIBUTION_ID }}
          PATHS: /*
          AWS_REGION: 'us-west-2'
          AWS_ACCESS_KEY_ID: ${{ secrets.FAMILIARIZE_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.FAMILIARIZE_SECRET_ACCESS }}
