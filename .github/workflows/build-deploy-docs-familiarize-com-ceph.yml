name: docs.familiarize.com (Build & Deploy)-Ceph

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["docs.familiarize.com (Translate)"]
    types: [completed]

jobs:
  build:
    name: Build and Deploy Job
    runs-on: ubuntu-latest
    timeout-minutes: 180
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout workflows repo
        uses: actions/checkout@v4

      - name: Checkout docs.familiarize.com (private)
        uses: actions/checkout@v4
        with:
          repository: familiarizeptyltd/docs.familiarize.com
          path: docs_repo
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Generate only static/llms.txt
      - name: Generate llms.txt
        working-directory: docs_repo
        env:
          BASE_URL: "https://docs.familiarize.com"   # optional; remove to use relative links
          MAX_LINKS: "5000"                           # optional cap
          VALIDATE_HTTP: "0"                         # 0|1  (default 0 = off) - 404 checking
          VALIDATE_MAX: "800"                        # cap validated URLs
          VALIDATE_TIMEOUT: "3"                      # seconds per request
          ALLOW_EXTERNAL: "0"                        # skip other domains
          STRICT_URL: "0"                            # respect front-matter "url:"
        run: |
          python3 scripts/generate_llms.py

      # Commit only llms.txt if changed
      - name: Commit llms.txt (if changed)
        working-directory: docs_repo
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [[ -n "$(git status --porcelain static/llms.txt)" ]]; then
            git add static/llms.txt
            git commit -m "Updated llms.txt [CI]"
            git push origin HEAD:main
            echo "Pushed static/llms.txt to private repo."
          else
            echo "No changes in static/llms.txt; skipping commit."
          fi      

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "0.123.8"

      - name: Build Hugo (keep-alive)
        working-directory: docs_repo
        shell: bash
        run: |
          ( while true; do echo "[$(date)] build alive"; sleep 900; done ) &
          KEEPALIVE_PID=$!
          hugo --logLevel debug --panicOnWarning --trace --printPathWarnings --printMemoryUsage
          kill $KEEPALIVE_PID

      # (Recommended) Ensure AWS CLI exists (ubuntu-latest usually has it, but this makes it deterministic)
      - name: Setup AWS CLI
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v aws >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y awscli
          fi
          aws --version

      # --- Ceph S3 sync ---
      - name: Sync Website to Ceph S3 (aws s3 sync)
        shell: bash
        env:
          AWS_ENDPOINT_URL:       ${{ vars.AWS_ENDPOINT_URL }}
          AWS_DEFAULT_REGION:     ${{ vars.AWS_DEFAULT_REGION }}
          AWS_REGION:             ${{ vars.AWS_DEFAULT_REGION }}
          AWS_S3_FORCE_PATH_STYLE: "true"  # helpful for Ceph; harmless on AWS
          AWS_ACCESS_KEY_ID:      ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail

          SRC="docs_repo/public"
          DEST="s3://docs-familiarize-com"

          test -d "$SRC" || { echo "Missing build output: $SRC"; exit 1; }

          echo "Syncing: $SRC -> $DEST"
          aws s3 sync "$SRC" "$DEST" \
            --endpoint-url "$AWS_ENDPOINT_URL" \
            --only-show-errors \
            --delete
    
