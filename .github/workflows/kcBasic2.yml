name: KC-Basic (Kilocode-Provider)

on:
  workflow_dispatch:  

jobs:
  demo:
    runs-on: ubuntu-latest

    env:
      KILOCODE_TOKEN: ${{ secrets.KILOCODE_API_KEY }}
      OPENAI_COMPAT_TOKEN: ${{ secrets.OPENAI_COMPAT_API_KEY }}
      OPENAI_COMPAT_MODEL: ${{ secrets.OPENAI_COMPAT_MODEL }}
      OPENAI_COMPAT_BASE_URL: ${{ secrets.OPENAI_COMPAT_BASE_URL }}     
      LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
      # MODEL: openai/gpt-4o-mini
      # MODEL: x-ai/grok-code-fast-1
      # MODEL: minimax/minimax-m2:free

    steps:
      - name: Basics
        run: |
          set -euxo pipefail
          node -v
          npm -v

      - name: Install KiloCode CLI
        run: |
          set -euxo pipefail
          npm install -g @kilocode/cli
          kilocode --version || true

      - name: Configure KiloCode (non-interactive; enable writes)
        run: |
          set -euxo pipefail
          mkdir -p ~/.kilocode/cli
          cat <<EOF > ~/.kilocode/cli/config.json
          {
            "version": "1.0.0",
            "mode": "code",
            "telemetry": true,
            "provider": "default",
            "providers": [              
              {
                "id": "kilocode",
                "provider": "kilocode",
                "kilocodeToken": "${KILOCODE_TOKEN}",
                "kilocodeModel": "minimax/minimax-m2:free",
                "kilocodeOrganizationId": ""
              },
              {
                "id": "openai",
                "provider": "openai",
                "openAiApiKey": "${OPENAI_COMPAT_TOKEN}",
                "apiModelId": "${OPENAI_COMPAT_MODEL}",
                "openAiBaseUrl": "${OPENAI_COMPAT_BASE_URL}"
              },
              {
                "id": "openainative",
                "provider": "openai-native",
                "openAiNativeApiKey": "${OPENAI_COMPAT_TOKEN}",
                "apiModelId": "${OPENAI_COMPAT_MODEL}",
                "openAiNativeBaseUrl": "${OPENAI_COMPAT_BASE_URL}",
                "openAiNativeServiceTier": "auto"
              },
              {
                "id": "default",
                "provider": "litellm",
                "litellmApiKey": "${OPENAI_COMPAT_TOKEN}",
                "litellmModelId": "gpt-oss",
                "litellmBaseUrl": "${LLM_BASE_URL}",
                "litellmUsePromptCache": true
              }
            ],
            "autoApproval": {
              "enabled": true,
              "read": { "enabled": true, "outside": true },
              "write": { "enabled": true, "outside": true, "protected": false },
              "execute": {
                "enabled": true,
                "allowed": ["git", "npm", "pnpm", "python"],
                "denied": ["rm -rf", "sudo"]
              },
              "browser": { "enabled": true },
              "mcp": { "enabled": true },
              "mode": { "enabled": true },
              "subtasks": { "enabled": true },
              "question": { "enabled": false, "timeout": 60 },
              "retry": { "enabled": true, "delay": 10 },
              "todo": { "enabled": true }
            },
            "theme": "dark",
            "customThemes": {}
          }
          EOF

      - name: Run KiloCode in auto mode
        run: |
          set -euxo pipefail
          kilocode --auto --timeout 150 "Search for latest financial news in the global market and share at least 5 top news briefly."
