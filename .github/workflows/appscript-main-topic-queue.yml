name: AppScript Main (Monthly Topic Queue Generation)

# Generate and schedule topics for the next 30 days
# Runs automatically on the 1st of each month, or can be triggered manually

on:
  schedule:
    # Run on 1st of every month at 00:00 UTC (midnight)
    - cron: '0 0 1 * *'
  
  workflow_dispatch:
    inputs:
      queue_duration_days:
        description: 'Queue duration in days (1-365)'
        required: false
        default: '30'
        type: string
      daily_quota:
        description: 'Topics to generate per day'
        required: false
        default: '7'
        type: string
      dry_run:
        description: 'Dry run mode (no commits)'
        required: false
        default: false
        type: boolean

jobs:
  generate-queue:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      TENANT_ID: docs.familiarize.com
      GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}

    steps:
      # Step 1: Checkout agent repository
      - name: Checkout agent repository
        uses: actions/checkout@v4
        with:
          repository: salmansarfraz/familiarizeWebsiteManagerAppsScript2App
          ref: main
          path: agent-repo
          token: ${{ secrets.FAMILIARIZEWEBSITEMANAGERAPPSSCRIPT2APP_AGENT_TOKEN || secrets.GH_PAT }}

      # Step 2: Checkout content repository (where queue will be stored)
      - name: Checkout content repository
        uses: actions/checkout@v4
        with:
          repository: familiarizeptyltd/docs.familiarize.com
          ref: agentMigration
          path: content-repo
          token: ${{ secrets.REPO_TOKEN || secrets.GH_PAT }}
          fetch-depth: 1

      # Step 3: Set up Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: agent-repo/familiarize-agent/requirements.txt

      # Step 4: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r agent-repo/familiarize-agent/requirements.txt

      # Step 5: Create necessary directories in content repo
      - name: Create .agent-data directories
        run: |
          mkdir -p content-repo/.agent-data/topic_queue
          mkdir -p content-repo/.agent-data/embeddings
          mkdir -p agent-repo/familiarize-agent/logs

      # Step 6: Setup Google credentials
      - name: Setup Google credentials
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > /tmp/google-credentials.json
          chmod 600 /tmp/google-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google-credentials.json" >> $GITHUB_ENV

      # Step 7: Clear Python cache
      - name: Clear Python cache
        working-directory: agent-repo/familiarize-agent
        run: |
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true

      # Step 8: Run queue generation script
      - name: Generate topic queue
        env:
          # Multi-tenant configuration
          TENANT_ID: docs.familiarize.com
          TARGET_REPO_PATH: ${{ github.workspace }}/content-repo
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
          
          # API Keys
          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          PROFESSIONALIZE_BASE_URL: https://llm.professionalize.com/v1
          PROFESSIONALIZE_LLM_MODEL: gpt-oss
          PROFESSIONALIZE_EMBEDDING_MODEL: qwen3-embedding-8b
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Google Services
          GOOGLE_CUSTOM_SEARCH_API_KEY: ${{ secrets.GOOGLE_CUSTOM_SEARCH_API_KEY }}
          CUSTOM_SEARCH_ENGINE_ID: ${{ secrets.CUSTOM_SEARCH_ENGINE_ID }}
          GOOGLE_ADS_CUSTOMER_ID: ${{ secrets.GOOGLE_ADS_CUSTOMER_ID }}
          GOOGLE_ADS_DEVELOPER_TOKEN: ${{ secrets.GOOGLE_ADS_DEVELOPER_TOKEN }}
          
          # LLM Provider
          LLM_PROVIDER: professionalize
          EMBEDDING_PROVIDER: professionalize
          EMBEDDING_DIMENSIONS: 1536
          
          # Queue Configuration
          QUEUE_DURATION_DAYS: ${{ github.event.inputs.queue_duration_days || '30' }}
          DAILY_QUOTA: ${{ github.event.inputs.daily_quota || '7' }}
          
        working-directory: agent-repo/familiarize-agent
        run: |
          echo "========================================================================"
          echo "Monthly Topic Queue Generation - Multi-Tenant Architecture"
          echo "========================================================================"
          echo ""
          echo "Configuration:"
          echo "  - Tenant: ${TENANT_ID}"
          echo "  - Duration: ${QUEUE_DURATION_DAYS} days"
          echo "  - Daily Quota: ${DAILY_QUOTA} topics/day"
          echo "  - Total Topics: $((QUEUE_DURATION_DAYS * DAILY_QUOTA))"
          echo "  - Queue Storage: ${TARGET_REPO_PATH}/.agent-data/topic_queue/"
          echo "  - Trigger: ${{ github.event_name }}"
          echo ""
          
          # Run queue scheduler with tenant parameter
          python src/scripts/queue_topic_scheduler.py --tenant docs.familiarize.com
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "‚úÖ Queue generation completed successfully!"
          else
            echo ""
            echo "‚ùå Queue generation failed with exit code: $EXIT_CODE"
            exit $EXIT_CODE
          fi

      # Step 9: Display queue statistics
      - name: Display queue statistics
        if: always()
        run: |
          echo "========================================================================"
          echo "Queue Statistics"
          echo "========================================================================"
          
          if [ -d "content-repo/.agent-data/topic_queue" ]; then
            echo ""
            echo "Queue database in content repo:"
            ls -lh content-repo/.agent-data/topic_queue/
            echo ""
            
            echo "Embeddings database in content repo:"
            ls -lh content-repo/.agent-data/embeddings/ || echo "No embeddings yet"
          else
            echo "‚ö†Ô∏è  Queue database not found in content repo"
          fi
          
          if [ -f "agent-repo/familiarize-agent/logs/agent.log" ]; then
            echo ""
            echo "Recent log entries:"
            echo "---"
            tail -n 30 agent-repo/familiarize-agent/logs/agent.log | grep -E "(queue|topics|scheduled|tier)" || echo "No queue logs found"
          fi

      # Step 10: Commit queue to content repository
      - name: Commit queue to content repository
        if: ${{ !github.event.inputs.dry_run }}
        working-directory: content-repo
        run: |
          git config user.name "Familiarize Agent"
          git config user.email "agent@familiarize.com"

          # Add .agent-data directory (queue + embeddings)
          git add .agent-data/

          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  No queue changes to commit"
          else
            DURATION="${{ github.event.inputs.queue_duration_days || '30' }}"
            QUOTA="${{ github.event.inputs.daily_quota || '7' }}"
            TOTAL=$((DURATION * QUOTA))
            
            git commit -m "ü§ñ Generate ${DURATION}-day topic queue (${TOTAL} topics)
            
            Queue Details:
            - Duration: ${DURATION} days
            - Daily quota: ${QUOTA} topics/day
            - Total topics: ${TOTAL}
            - Start date: $(date -d '+1 day' +'%Y-%m-%d' 2>/dev/null || date -v+1d +'%Y-%m-%d')
            - End date: $(date -d '+${DURATION} days' +'%Y-%m-%d' 2>/dev/null || date -v+${DURATION}d +'%Y-%m-%d')
            
            Storage:
            - Queue: .agent-data/topic_queue/
            - Embeddings: .agent-data/embeddings/
            
            Generated: $(date +'%Y-%m-%d %H:%M UTC')
            "
            
            git push
            
            echo "‚úÖ Queue committed to content repository successfully"
          fi

      # Step 11: Upload artifacts
      - name: Upload queue artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: topic-queue-${{ github.run_number }}
          path: |
            content-repo/.agent-data/
            agent-repo/familiarize-agent/logs/
          retention-days: 90

      # Step 12: Generate summary
      - name: Generate summary
        if: always()
        run: |
          echo "## üìÖ Monthly Queue Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant**: \`docs.familiarize.com\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Queue Duration**: ${{ github.event.inputs.queue_duration_days || '30' }} days" >> $GITHUB_STEP_SUMMARY
          echo "- **Daily Quota**: ${{ github.event.inputs.daily_quota || '7' }} topics/day" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Topics**: $(((${{ github.event.inputs.queue_duration_days || '30' }} * ${{ github.event.inputs.daily_quota || '7' }})))" >> $GITHUB_STEP_SUMMARY
          echo "- **Queue Storage**: \`content-repo/.agent-data/topic_queue/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Architecture" >> $GITHUB_STEP_SUMMARY
          echo "- **Agent Repo**: Code only (no data)" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Repo**: Content + operational data (\`.agent-data/\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-Tenant**: Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f agent-repo/familiarize-agent/logs/agent.log ]; then
            echo "### Execution Logs" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -n 50 agent-repo/familiarize-agent/logs/agent.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Queue populated for next ${{ github.event.inputs.queue_duration_days || '30' }} days" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Embeddings built for uniqueness checking" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Data committed to content repository" >> $GITHUB_STEP_SUMMARY
          echo "- ‚è≠Ô∏è  Daily workflow will fetch topics from queue" >> $GITHUB_STEP_SUMMARY

      # Step 13: Notify on failure
      - name: Notify on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚ùå Queue Generation Failed: ${{ github.workflow }}'
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Familiarize Agent <${{ secrets.SMTP_USERNAME }}>
          body: |
            üö® Monthly Topic Queue Generation Failed

            Tenant: docs.familiarize.com
            Agent Repository: salmansarfraz/familiarizeWebsiteManagerAppsScript2App
            Content Repository: familiarizeptyltd/docs.familiarize.com

            Configuration:
            - Queue Duration: ${{ github.event.inputs.queue_duration_days || '30' }} days
            - Daily Quota: ${{ github.event.inputs.daily_quota || '7' }} topics/day

            Check logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        continue-on-error: true

      # Step 14: Notify on success
      - name: Notify on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: '‚úÖ Queue Generated Successfully: ${{ github.workflow }}'
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Familiarize Agent <${{ secrets.SMTP_USERNAME }}>
          body: |
            ‚úÖ Monthly Topic Queue Generation Completed

            Tenant: docs.familiarize.com
            Content Repository: familiarizeptyltd/docs.familiarize.com
            
            Configuration:
            - Duration: ${{ github.event.inputs.queue_duration_days || '30' }} days
            - Daily Quota: ${{ github.event.inputs.daily_quota || '7' }} topics/day
            - Total Topics: $((${{ github.event.inputs.queue_duration_days || '30' }} * ${{ github.event.inputs.daily_quota || '7' }}))

            Queue Storage:
            - Location: .agent-data/topic_queue/ (in content repo)
            - Embeddings: .agent-data/embeddings/ (in content repo)

            View queue:
            https://github.com/familiarizeptyltd/docs.familiarize.com/tree/agentMigration/.agent-data
            
            View logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        continue-on-error: true
