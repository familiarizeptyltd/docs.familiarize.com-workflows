name: Hugo Content Agent

on:
  workflow_dispatch:
    inputs:
      prompt_file:
        description: 'Path to prompt file in Hugo repo (relative to repo root)'
        required: true
        default: 'prompts/country-pages-prompt.txt'
        type: string
      country:
        description: 'Target country'
        required: true
        default: 'UAE'
      num_pages:
        description: 'Number of pages to generate'
        required: false
        default: '3'
      llm_provider:
        description: 'LLM provider (openai/grok/gpt-oss)'
        required: false
        default: 'openai'
      llm_model:
        description: 'LLM model'
        required: false
        default: 'gpt-4o-mini'
      dry_run:
        description: 'Dry run mode (no PR creation)'
        required: false
        type: boolean
        default: false

jobs:
  generate-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout public workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout private hugoAgent repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.AGENT_REPO }}
          token: ${{ secrets.AGENT_REPO_TOKEN }}
          path: hugo-agent
          fetch-depth: 0

      - name: Checkout private Hugo site repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.REPO }}
          token: ${{ secrets.REPO_TOKEN }}
          path: hugo-repo
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r hugo-agent/requirements.txt

      - name: Install Hugo
        run: |
          sudo apt-get update
          sudo apt-get install -y hugo

      - name: Verify GitHub CLI
        run: |
          gh --version

      - name: Configure Git Identity
        run: |
          cd hugo-repo
          git config user.name "Hugo Agent Bot"
          git config user.email "hugoagent@familiarize.com"
          cd ..

      - name: Run Hugo Agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GPT_OSS_API_KEY: ${{ secrets.GPT_OSS_API_KEY }}
          GPT_OSS_BASE_URL: ${{ secrets.GPT_OSS_BASE_URL }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          GOOGLE_CSE_API_KEY: ${{ secrets.GOOGLE_CSE_API_KEY }}
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          python -m src.main \
            --repo-path ../hugo-repo \
            --prompt-file "${{ github.event.inputs.prompt_file }}" \
            --country "${{ github.event.inputs.country }}" \
            --num-pages "${{ github.event.inputs.num_pages }}" \
            --llm-provider "${{ github.event.inputs.llm_provider }}" \
            --llm-model "${{ github.event.inputs.llm_model }}" \
            $DRY_RUN_FLAG
        working-directory: hugo-agent

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hugo-agent-run-${{ github.run_id }}
          path: |
            hugo-repo/agent-run-*.log
            hugo-repo/.hugo_build.log
          if-no-files-found: ignore
          retention-days: 30
