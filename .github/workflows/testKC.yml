
name: KiloCode - headless demo (Target)

on:
  workflow_dispatch:
    inputs:
      prompt_path:
        description: "Path to the prompt file inside the target repository"
        required: true
        default: "prompts/country-pages.md"
        type: string

      target_repo:
        description: "Target GitHub repo in ORG/REPO format"
        required: true
        default: "familiarizeptyltd/docs.familiarize.com"
        type: string

      commit_mode:
        description: "Choose how to deliver changes: pull request or direct push to main"
        required: true
        type: choice
        options:
          - pr
          - direct
        default: pr

jobs:
  demo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      KILOCODE_TOKEN: ${{ secrets.KILOCODE_API_KEY }}
      OPENAI_COMPAT_TOKEN: ${{ secrets.OPENAI_COMPAT_API_KEY }}
      OPENAI_COMPAT_MODEL: ${{ secrets.OPENAI_COMPAT_MODEL }}
      OPENAI_COMPAT_BASE_URL: ${{ secrets.OPENAI_COMPAT_BASE_URL }}      
      REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
      # MODEL: openai/gpt-4o-mini
      # MODEL: x-ai/grok-code-fast-1
      # MODEL: minimax/minimax-m2:free
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_CSE_API_KEY }}
      GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ENGINE_ID }}

    steps:
      - name: Checkout Target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          path: target_repo
          token: ${{ env.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true

      - name: Basics
        run: |
          set -euxo pipefail
          node -v
          npm -v

      - name: Install MCP server dependencies (Python)
        run: |
          set -euxo pipefail
          cd target_repo
          python -m pip install --upgrade pip
          pip install -r mcp/requirements.txt

      - name: Install KiloCode CLI
        run: |
          set -euxo pipefail
          npm install -g @kilocode/cli
          kilocode --version || true

      - name: Configure KiloCode (non-interactive; enable writes + MCP)
        run: |
          set -euxo pipefail
          mkdir -p ~/.kilocode/cli
          cat <<'EOF' > ~/.kilocode/cli/config.json
          {
            "version": "1.0.0",
            "mode": "code",
            "telemetry": true,
            "provider": "default",
            "providers": [              
              {
                "id": "default",
                "provider": "kilocode",
                "kilocodeToken": "${KILOCODE_TOKEN}",
                "kilocodeModel": "x-ai/grok-code-fast-1",
                "kilocodeOrganizationId": ""
              }              
            ],
            "autoApproval": {
              "enabled": true,
              "read": { "enabled": true, "outside": true },
              "write": { "enabled": true, "outside": true, "protected": false },
              "execute": {
                "enabled": true,
                "allowed": ["git", "npm", "pnpm", "python"],
                "denied": ["rm -rf", "sudo"]
              },
              "browser": { "enabled": true },
              "mcp": { "enabled": true },
              "mode": { "enabled": true },
              "subtasks": { "enabled": true },
              "question": { "enabled": false, "timeout": 60 },
              "retry": { "enabled": true, "delay": 10 },
              "todo": { "enabled": true }
            },
            "theme": "dark",
            "customThemes": {}
          }
          EOF

          # MCP servers config â€“ this is what the CLI will read
          cat <<'EOF' > ~/.kilocode/cli/mcp.json
          {
            "mcpServers": {
              "web_search": {
                "command": "python",
                "args": ["mcp/web_search.py"],
                "disabled": false,
                "timeout": 600000
              }
            }
          }
          EOF

      - name: Run KiloCode in auto mode (Target workspace)
        run: |
          set -euxo pipefail
          kilocode --auto --workspace ./target_repo --timeout 1200 < "target_repo/${{ inputs.prompt_path }}"

      # --- Direct commit path ---
      - name: Commit & Push changes to Target (direct to main)
        if: ${{ inputs.commit_mode == 'direct' }}
        run: |
          set -euxo pipefail
          cd target_repo
          git config user.name "My agent"
          git config user.email "my.agent@github.com"
          git fetch origin
          git pull --strategy=ours origin main
          git add .
          git diff --cached --quiet || git commit -m "Changes by KC on ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          git push origin HEAD:main

      # --- Pull request path ---
      - name: Create Pull Request to Target
        if: ${{ inputs.commit_mode == 'pr' }}
        env:
          GH_TOKEN: ${{ env.REPO_TOKEN }}
        run: |
          set -euxo pipefail
          cd target_repo
          git config user.name "My agent"
          git config user.email "my.agent@github.com"
          git fetch origin
          git checkout -B "kc-auto-$(date -u +'%Y%m%d-%H%M%S')"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "KiloCode: automated changes ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          git push --set-upstream origin HEAD
          gh pr create \
            --title "KiloCode: automated changes" \
            --body "Automated updates generated by KiloCode." \
            --base main \
            --head "$(git rev-parse --abbrev-ref HEAD)" \
            --repo "${{ inputs.target_repo }}"
