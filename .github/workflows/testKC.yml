name: KiloCode - headless demo

on:
  workflow_dispatch:

jobs:
  demo:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      KILOCODE_TOKEN: ${{ secrets.KILOCODE_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: familiarizeptyltd/docs.familiarize.com
          path: docs_repo
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true

      - name: Basics
        run: |
          set -euxo pipefail
          node -v
          npm -v

      - name: Install KiloCode CLI
        run: |
          set -euxo pipefail
          npm install -g @kilocode/cli
          kilocode --version || true

      - name: Configure KiloCode (non-interactive; enable writes)
        run: |
          set -euxo pipefail
          mkdir -p ~/.kilocode/cli
          cat <<'EOF' > ~/.kilocode/cli/config.json
          {
            "version": "1.0.0",
            "mode": "code",
            "telemetry": true,
            "provider": "default",
            "providers": [
              {
                "id": "default",
                "provider": "kilocode",
                "kilocodeToken": "${KILOCODE_TOKEN}",
                "kilocodeModel": "openai/gpt-4o-mini",
                "kilocodeOrganizationId": ""
              }
            ],
            "autoApproval": {
              "enabled": true,
              "read": { "enabled": true, "outside": true },
              "write": { "enabled": true, "outside": true, "protected": false },
              "execute": {
                "enabled": true,
                "allowed": ["git", "npm", "pnpm"],
                "denied": ["rm -rf", "sudo"]
              },
              "browser": { "enabled": false },
              "mcp": { "enabled": true },
              "mode": { "enabled": true },
              "subtasks": { "enabled": true },
              "question": { "enabled": false, "timeout": 60 },
              "retry": { "enabled": true, "delay": 10 },
              "todo": { "enabled": true }
            },
            "theme": "dark",
            "customThemes": {}
          }
          EOF

      - name: Run Kilo Code in auto mode
        run: |
          kilocode --auto --workspace ./docs_repo --timeout 600 < docs_repo/prompts/uae-pages1.md
          
      - name: Commit & Push Changes to Hugo repo
        run: |
          cd docs_repo
          git config user.name "My agent"
          git config user.email "my.agent@github.com"
          git fetch origin
          git pull --strategy=ours origin main
          git add .
          git diff --cached --quiet || git commit -m "Changes by KC on ($(date -u +'%Y-%m-%dT%H:%M:%SZ'))"
          # Push back to main branch of the Docs repo
          git push origin HEAD:main
