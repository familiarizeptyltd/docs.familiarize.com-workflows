name: KiloCode CLI demo (non-interactive)

on:
  workflow_dispatch:

jobs:
  kilocode-demo:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install KiloCode CLI
        run: |
          npm install -g @kilocode/cli
          kilocode --version
        # per docs: npm install -g @kilocode/cli
        # and CLI supports --auto for CI. :contentReference[oaicite:1]{index=1}

      - name: Write KiloCode config for CLI path
        env:
          KILOCODE_TOKEN: ${{ secrets.KILOCODE_API_KEY }}
        run: |
          # Create both canonical and legacy locations for safety
          mkdir -p ~/.kilocode/cli
          mkdir -p ~/.kilocode

          cat > ~/.kilocode/cli/config.json <<'JSON'
          {
            "version": 1,
            "currentProvider": "default",
            "providers": [
              {
                "id": "default",
                "provider": "kilocode",
                "kilocodeToken": "__KILOCODE_TOKEN__",
                "kilocodeModel": "xai/grok-code-fast-1"
              }
            ],
            "autoApproval": {
              "enabled": true,
              "read": { "enabled": true, "outside": false },
              "write": { "enabled": true, "outside": false, "protected": false },
              "execute": {
                "enabled": true,
                "allowed": ["git", "node", "npm", "pnpm"],
                "denied": ["sudo", "rm -rf", "git push --force"]
              },
              "question": { "enabled": false, "timeout": 60 },
              "retry": { "enabled": true, "delay": 10 }
            }
          }
          JSON

          # (optional) also mirror to ~/.kilocode/config.json for older builds
          cp ~/.kilocode/cli/config.json ~/.kilocode/config.json

          # inject token
          sed -i "s/__KILOCODE_TOKEN__/${KILOCODE_TOKEN//\//\\/}/" ~/.kilocode/cli/config.json
          sed -i "s/__KILOCODE_TOKEN__/${KILOCODE_TOKEN//\//\\/}/" ~/.kilocode/config.json

      - name: Run KiloCode in autonomous mode
        run: |
          echo "Create or update a file named KILOCODE_DEMO.md at the repo root. Add a markdown H1 'KiloCode CLI Demo', today's UTC timestamp, and a short note: 'Hello from GitHub Actions.' Keep it idempotent." \
          | kilocode --auto --timeout 300
        # --auto and timeouts are documented for CI usage. :contentReference[oaicite:2]{index=2}

      - name: Commit and push changes (if any)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: update via KiloCode CLI demo"
            git push
          else
            echo "No changes to commit."
          fi
