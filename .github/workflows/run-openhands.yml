name: OpenHands

on:
  workflow_dispatch:

jobs:
  openhands:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      # ==== Your knobs ====
      TARGET_REPO: familiarizeptyltd/docs.familiarize.com
      REPO_DIR: docs_repo
      TARGET_BRANCH: agent/openhands-run

      PROMPT_TEMPLATE: prompts/country-topic-template.md
      PROFILE_KEY: UAE
      RAW_PROMPT_FILE: prompts/uae-pages.md

      # LLM + browsing/search
      LLM_PROVIDER: openai            # openai | openai_compat | grok
      LLM_MODEL: gpt-4o-mini
      OH_ENABLE_BROWSING: "true"
      OH_ENABLE_SEARCH: "true"

      # Images
      SANDBOX_RUNTIME_CONTAINER_IMAGE: docker.openhands.dev/openhands/runtime:0.60-nikolaik
      OPENHANDS_IMAGE: docker.openhands.dev/openhands/openhands:0.60

      # Logging
      AGENT_LOG_DIR: openhands_run
      OPENHANDS_LOG_LEVEL: warning
      OPENHANDS_MAX_STEPS: "60"
      OPENHANDS_HARD_TIMEOUT_SEC: "1200"

    steps:
      - name: Checkout workflows repo (this repo)
        uses: actions/checkout@v4

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          path: ${{ env.REPO_DIR }}
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install helper deps
        run: |
          python -m pip install --upgrade pip
          pip install pygithub

      - name: Render/fallback prompt file
        env:
          PROFILE_KEY: ${{ env.PROFILE_KEY }}
          PROMPT_TEMPLATE: ${{ env.PROMPT_TEMPLATE }}
          RAW_PROMPT_FILE: ${{ env.RAW_PROMPT_FILE }}
          REPO_DIR: ${{ env.REPO_DIR }}
        run: |
          set -Eeuo pipefail

          TEMPLATE_PATH="${REPO_DIR}/${PROMPT_TEMPLATE}"
          PROFILES_NEW="${REPO_DIR}/prompts/country-profiles.json"
          PROFILES_OLD="${REPO_DIR}/prompts/country_profiles.json"
          RAW_PATH="${REPO_DIR}/${RAW_PROMPT_FILE}"

          mkdir -p "${REPO_DIR}/.agent"

          use_template=false
          if [[ -f "${PROFILES_NEW}" ]]; then PROFILES_PATH="${PROFILES_NEW}";
          elif [[ -f "${PROFILES_OLD}" ]]; then PROFILES_PATH="${PROFILES_OLD}";
          else PROFILES_PATH=""; fi

          if [[ -n "${PROMPT_TEMPLATE}" && -f "${TEMPLATE_PATH}" && -n "${PROFILES_PATH}" ]]; then
            use_template=true
          fi

          if $use_template; then
            echo "Using template: ${TEMPLATE_PATH} (profile=${PROFILE_KEY}) with ${PROFILES_PATH}"
            python scripts/render_prompt.py \
              --profiles "${PROFILES_PATH}" \
              --profile-key "${PROFILE_KEY}" \
              --template   "${TEMPLATE_PATH}" \
              --output     "${REPO_DIR}/.agent/rendered_prompt.md"
            echo "PROMPT_FILE=.agent/rendered_prompt.md" >> "$GITHUB_ENV"
          else
            echo "Template/profiles missing. Falling back to RAW: ${RAW_PATH}"
            if [[ ! -f "${RAW_PATH}" ]]; then
              echo "❌ Missing inputs. Need either template+profiles or RAW."
              exit 1
            fi
            echo "PROMPT_FILE=${RAW_PROMPT_FILE}" >> "$GITHUB_ENV"
          fi

      - name: Ensure prompt exists
        env:
          REPO_DIR: ${{ env.REPO_DIR }}
          PROMPT_FILE: ${{ env.PROMPT_FILE }}
        run: |
          set -Eeuo pipefail
          test -f "${REPO_DIR}/${PROMPT_FILE}" || (echo "❌ Prompt not found: ${REPO_DIR}/${PROMPT_FILE}"; exit 1)

      - name: Configure git author
        working-directory: ${{ env.REPO_DIR }}
        run: |
          git config user.name  "ci-agent"
          git config user.email "ci-agent@users.noreply.github.com"

      - name: Create/switch target branch
        working-directory: ${{ env.REPO_DIR }}
        env:
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
        run: |
          set -Eeuo pipefail
          if git rev-parse --verify "${TARGET_BRANCH}" >/dev/null 2>&1; then
            git checkout "${TARGET_BRANCH}"
          else
            git checkout -b "${TARGET_BRANCH}"
          fi

      - name: Pull runtime images
        env:
          SANDBOX_RUNTIME_CONTAINER_IMAGE: ${{ env.SANDBOX_RUNTIME_CONTAINER_IMAGE }}
          OPENHANDS_IMAGE: ${{ env.OPENHANDS_IMAGE }}
        run: |
          docker pull "${SANDBOX_RUNTIME_CONTAINER_IMAGE}"
          docker pull "${OPENHANDS_IMAGE}"

      - name: Launch OpenHands (single-line docker run; no backslashes)
        env:
          # repo + files
          REPO_DIR: ${{ env.REPO_DIR }}
          AGENT_LOG_DIR: ${{ env.AGENT_LOG_DIR }}
          PROMPT_FILE: ${{ env.PROMPT_FILE }}

          # images
          OPENHANDS_IMAGE: ${{ env.OPENHANDS_IMAGE }}
          SANDBOX_RUNTIME_CONTAINER_IMAGE: ${{ env.SANDBOX_RUNTIME_CONTAINER_IMAGE }}

          # provider selection
          LLM_PROVIDER: ${{ env.LLM_PROVIDER }}
          LLM_MODEL: ${{ env.LLM_MODEL }}
          OH_ENABLE_BROWSING: ${{ env.OH_ENABLE_BROWSING }}
          OH_ENABLE_SEARCH: ${{ env.OH_ENABLE_SEARCH }}

          # keys
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_COMPAT_API_KEY: ${{ secrets.OPENAI_COMPAT_API_KEY }}
          OPENAI_COMPAT_BASE_URL: ${{ secrets.OPENAI_COMPAT_BASE_URL }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

          # tuning
          OPENHANDS_LOG_LEVEL: ${{ env.OPENHANDS_LOG_LEVEL }}
          OPENHANDS_MAX_STEPS: ${{ env.OPENHANDS_MAX_STEPS }}
          OPENHANDS_HARD_TIMEOUT_SEC: ${{ env.OPENHANDS_HARD_TIMEOUT_SEC }}
        run: |
          set -Eeuo pipefail

          mkdir -p "${AGENT_LOG_DIR}" "${REPO_DIR}/.openhands" "${REPO_DIR}/.agent"
          chmod 0777 "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands" || true

          HOST_GOAL="${REPO_DIR}/${PROMPT_FILE}"
          echo "✅ Found goal on host: ${HOST_GOAL}"
          ls -la "${REPO_DIR}/.agent" || true

          WRAPPED_HOST="${REPO_DIR}/.agent/_wrapped_goal.md"
          {
            printf '%s\n' "# SYSTEM EXECUTION DIRECTIVE"
            printf '%s\n\n' "You are CodeActAgent running headless in a Git repo at /workspace."
            printf '%s\n' "## REQUIRED ACTIONS"
            printf '%s\n' "1) Plan briefly."
            printf '%s\n' "2) Create the exact new Markdown files requested (do NOT just propose)."
            printf '%s\n' "3) Validate YAML front matter and dates."
            printf '%s\n' "4) Save files to the exact required paths."
            printf '%s\n\n' "5) Finish when files are written."
            printf '%s\n' "## GUARANTEES"
            printf '%s\n' "- If tags file is missing, pick 1–2 best-fit existing tags or skip with note; still create files."
            printf '%s\n\n' "- If any directory is missing, create it and continue."
            printf '%s\n\n' "----- ORIGINAL GOAL BELOW -----"
            cat "${HOST_GOAL}"
          } > "${WRAPPED_HOST}"

          # Build OpenHands config (Hugo-safe)
          CFG="${REPO_DIR}/.openhands/config.toml"
          {
            printf '%s\n' '[core]'
            printf '%s\n' 'agent = "CodeActAgent"'
            printf '%s\n' "max_steps = ${OPENHANDS_MAX_STEPS}"
            printf '%s\n' "hard_timeout_sec = ${OPENHANDS_HARD_TIMEOUT_SEC}"
            printf '%s\n' 'enable_browsing = true'
            printf '%s\n' 'enable_search = true'
            printf '%s\n' ''
            printf '%s\n' '[workspace]'
            printf '%s\n' 'root = "/workspace"'
            printf '%s\n' 'write_whitelist_globs = ['
            printf '%s\n' '  "content/**",'
            printf '%s\n' '  "themes/**",'
            printf '%s\n' '  ".agent/**",'
            printf '%s\n' '  ".env",'
            printf '%s\n' '  ".openhands/**",'
            printf '%s\n' '  "static/**",'
            printf '%s\n' '  "*.md"'
            printf '%s\n' ']'
            printf '%s\n' ''
            printf '%s\n' '[search]'
            printf '%s\n' 'provider = "tavily"'
          } > "${CFG}"

          echo "[]" > "${REPO_DIR}/.openhands/mcp.json"

          # Map provider to env the container expects
          case "${LLM_PROVIDER}" in
            openai)
              export LLM_API_KEY="${OPENAI_API_KEY}"
              ;;
            openai_compat)
              export LLM_API_KEY="${OPENAI_COMPAT_API_KEY}"
              export LLM_BASE_URL="${OPENAI_COMPAT_BASE_URL}"
              ;;
            grok)
              export LLM_API_KEY="${GROK_API_KEY}"
              ;;
            *)
              echo "Unsupported LLM provider: ${LLM_PROVIDER}"
              exit 1
              ;;
          esac

          # Optional browsing flag (robust to unset/CRLF)
          if [[ "${OH_ENABLE_BROWSING:-}" == "true" ]]; then
            export AGENT_ENABLE_BROWSING="true"
          fi

          # Single-line docker run to avoid CRLF/backslash pitfalls
          docker run --rm --pull=always -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}:/workspace" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}:/logs" \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands:/.openhands" \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands:/home/enduser/.openhands" \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands/config.toml:/workspace/config.toml:ro" \
            -w /workspace --add-host host.docker.internal:host-gateway \
            -e HOME="/home/enduser" \
            -e SANDBOX_RUNTIME_CONTAINER_IMAGE="${SANDBOX_RUNTIME_CONTAINER_IMAGE}" \
            -e SANDBOX_USER_ID="$(id -u)" \
            -e LLM_PROVIDER="${LLM_PROVIDER}" \
            -e LLM_MODEL="${LLM_MODEL}" \
            -e LLM_API_KEY="${LLM_API_KEY:-}" \
            -e LLM_BASE_URL="${LLM_BASE_URL:-}" \
            -e AGENT_ENABLE_BROWSING="${AGENT_ENABLE_BROWSING:-}" \
            -e OH_ENABLE_SEARCH="${OH_ENABLE_SEARCH}" \
            -e TAVILY_API_KEY="${TAVILY_API_KEY:-}" \
            -e OPENHANDS_LOG_LEVEL="${OPENHANDS_LOG_LEVEL:-warning}" \
            -e OPENHANDS_MAX_STEPS="${OPENHANDS_MAX_STEPS:-60}" \
            -e OPENHANDS_HARD_TIMEOUT_SEC="${OPENHANDS_HARD_TIMEOUT_SEC:-1200}" \
            -e GOAL_ABS="/workspace/.agent/_wrapped_goal.md" \
            "${OPENHANDS_IMAGE}" bash -lc 'set -Eeuo pipefail; VENV_PY="/app/.venv/bin/python"; test -f "/workspace/.agent/_wrapped_goal.md" || { echo "❌ Goal not visible"; ls -la /workspace/.agent || true; exit 1; }; "$VENV_PY" -m pip install --no-cache-dir --disable-pip-version-check -q python-dotenv || true; exec "$VENV_PY" -m openhands.core.main -f "/workspace/.agent/_wrapped_goal.md" -d "/workspace"'

      - name: Show agent output dir
        run: |
          echo "------- Agent output dir -------"
          ls -la "${AGENT_LOG_DIR}" || true

      - name: Upload agent logs (if any)
        uses: actions/upload-artifact@v4
        with:
          name: openhands-run-${{ github.run_id }}
          path: ${{ env.AGENT_LOG_DIR }}/
          if-no-files-found: warn
