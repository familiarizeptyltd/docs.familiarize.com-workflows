      - name: Launch OpenHands (hardened + docker CLI mount)
        env:
          # repo + files
          REPO_DIR: ${{ env.REPO_DIR }}
          AGENT_LOG_DIR: ${{ env.AGENT_LOG_DIR }}

          # images
          OPENHANDS_IMAGE: ${{ env.OPENHANDS_IMAGE }}
          SANDBOX_RUNTIME_CONTAINER_IMAGE: ${{ env.SANDBOX_RUNTIME_CONTAINER_IMAGE }}

          # provider selection
          LLM_PROVIDER: ${{ env.LLM_PROVIDER }}
          LLM_MODEL: ${{ env.LLM_MODEL }}

          # keys
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_COMPAT_API_KEY: ${{ secrets.OPENAI_COMPAT_API_KEY }}
          OPENAI_COMPAT_BASE_URL: ${{ secrets.OPENAI_COMPAT_BASE_URL }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

          # tuning
          OPENHANDS_LOG_LEVEL: ${{ env.OPENHANDS_LOG_LEVEL }}
        run: |
          set -Eeuo pipefail

          mkdir -p "${AGENT_LOG_DIR}" "${REPO_DIR}/.openhands" "${REPO_DIR}/.agent" "${REPO_DIR}/.openhands_state" "${AGENT_LOG_DIR}/dot_openhands" "${AGENT_LOG_DIR}/bin"
          chmod 0777 "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands" "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands_state" "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/dot_openhands" || true

          # --- Make a stable copy of the host docker CLI to mount into multiple PATH locations ---
          if [[ ! -x /usr/bin/docker ]]; then
            echo "❌ Host docker CLI not found at /usr/bin/docker"; which docker || true; exit 1
          fi
          cp /usr/bin/docker "${AGENT_LOG_DIR}/bin/docker"
          chmod +x "${AGENT_LOG_DIR}/bin/docker"

          HOST_GOAL="${REPO_DIR}/${PROMPT_FILE}"
          echo "✅ Found goal on host: ${HOST_GOAL}"

          # Wrap goal
          WRAPPED_HOST="${REPO_DIR}/.agent/_wrapped_goal.md"
          cat > "${WRAPPED_HOST}" << 'GOAL_EOF'
          # SYSTEM EXECUTION DIRECTIVE
          You are CodeActAgent running in a Git repo at /workspace.

          ## REQUIRED ACTIONS
          1) Plan briefly.
          2) Create the exact new Markdown files requested (do NOT just propose).
          3) Validate YAML front matter and dates.
          4) Save files to the exact required paths.
          5) Finish when files are written.

          ## CONSTRAINTS
          - Maximum 60 steps total
          - If tags file is missing, pick 1-2 best-fit existing tags or skip with note; still create files.
          - If any directory is missing, create it and continue.

          ----- ORIGINAL GOAL BELOW -----
          GOAL_EOF
          cat "${HOST_GOAL}" >> "${WRAPPED_HOST}"

          # Map provider → key(s)
          LLM_API_KEY=""; LLM_BASE_URL=""
          case "${LLM_PROVIDER}" in
            openai)         LLM_API_KEY="${OPENAI_API_KEY:-}" ;;
            openai_compat)  LLM_API_KEY="${OPENAI_COMPAT_API_KEY:-}"; LLM_BASE_URL="${OPENAI_COMPAT_BASE_URL:-}" ;;
            grok)           LLM_API_KEY="${GROK_API_KEY:-}" ;;
            *) echo "❌ Unsupported LLM provider: ${LLM_PROVIDER}"; exit 1 ;;
          esac
          if [[ -z "${LLM_API_KEY:-}" ]]; then
            echo "❌ Missing API key for provider '${LLM_PROVIDER}'"; exit 1
          fi

          # Build OpenHands config (0.60)
          CFG="${REPO_DIR}/.openhands/config.toml"
          {
            echo "[core]"
            echo "file_store      = \"local\""
            echo "file_store_path = \"/.openhands\""
            echo "jwt_secret      = \"${GITHUB_RUN_ID:-gha}.${GITHUB_RUN_NUMBER:-0}.${RANDOM}${RANDOM}\""

            echo ""
            echo "[llm]"
            echo "model = \"${LLM_MODEL}\""
            echo "api_key = \"${LLM_API_KEY}\""
            if [[ -n "${LLM_BASE_URL:-}" ]]; then
              echo "base_url = \"${LLM_BASE_URL}\""
            fi

            echo ""
            echo "[sandbox]"
            echo "base_container_image = \"${SANDBOX_RUNTIME_CONTAINER_IMAGE}\""
          } > "${CFG}"

          # Minimal MCP registry
          echo "[]" > "${REPO_DIR}/.openhands/mcp.json"

          # --- Preflight inside the app container: prove docker CLI is accessible and working ---
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/bin/docker:/usr/bin/docker:ro" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/bin/docker:/bin/docker:ro" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/bin/docker:/usr/local/bin/docker:ro" \
            -w / \
            "${OPENHANDS_IMAGE}" \
            bash -lc 'set -euxo pipefail; which docker; docker version; echo "Docker CLI OK inside app container."'

          # --- Run OpenHands (0.60 flags) ---
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/bin/docker:/usr/bin/docker:ro" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/bin/docker:/bin/docker:ro" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/bin/docker:/usr/local/bin/docker:ro" \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}:/workspace" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}:/openhands/logs" \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands:/openhands/config" \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands_state:/openhands/state" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}/dot_openhands:/.openhands" \
            -w /workspace \
            --add-host host.docker.internal:host-gateway \
            -e HOME="/home/enduser" \
            -e DOCKER_HOST="unix:///var/run/docker.sock" \
            -e SANDBOX_USER_ID="$(id -u)" \
            -e LLM_API_KEY="${LLM_API_KEY}" \
            -e LLM_MODEL="${LLM_MODEL}" \
            -e TAVILY_API_KEY="${TAVILY_API_KEY:-}" \
            "${OPENHANDS_IMAGE}" \
            bash -lc 'set -e; which docker || (echo "docker not found"; exit 1); docker version; \
              python -m openhands.core.main \
                --config-file /openhands/config/config.toml \
                -f "/workspace/.agent/_wrapped_goal.md" \
                -d /workspace \
                -i 60 \
                --log-level "'"${OPENHANDS_LOG_LEVEL}"'"'
