name: OpenHands

on:
  workflow_dispatch:
    inputs:
      prompt_template:
        description: "Template path (in private repo). Leave empty to use raw prompt_file."
        required: false
        default: "prompts/country-topic-template.md"
      profile_key:
        description: "Country profile key (e.g., UAE)"
        required: false
        default: "UAE"
      prompt_file:
        description: "RAW prompt path (used if template missing)"
        required: false
        default: "prompts/uae-pages.md"
      branch_name:
        description: "Target branch (created if missing)"
        required: true
        default: "agent/openhands-run"
      llm_provider:
        description: "LLM provider: openai | openai_compat | grok"
        required: true
        default: "openai"
      llm_model:
        description: "Model id (e.g., gpt-4o-mini)"
        required: true
        default: "gpt-4o-mini"
      browsing_enabled:
        description: "Enable in-agent web browsing?"
        required: true
        default: "true"
      web_search_enabled:
        description: "Enable web search?"
        required: true
        default: "true"
      commit_mode:
        description: "direct = push to branch, pr = open PR"
        required: true
        default: "pr"

jobs:
  openhands:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      # Paths
      REPO_DIR: docs_repo
      AGENT_LOG_DIR: openhands_run

      # Inputs -> env
      PROMPT_TEMPLATE: ${{ github.event.inputs.prompt_template }}
      PROFILE_KEY: ${{ github.event.inputs.profile_key }}
      RAW_PROMPT_FILE: ${{ github.event.inputs.prompt_file }}
      TARGET_BRANCH: ${{ github.event.inputs.branch_name }}
      LLM_PROVIDER: ${{ github.event.inputs.llm_provider }}
      LLM_MODEL: ${{ github.event.inputs.llm_model }}
      ENABLE_BROWSING: ${{ github.event.inputs.browsing_enabled }}
      ENABLE_SEARCH: ${{ github.event.inputs.web_search_enabled }}
      COMMIT_MODE: ${{ github.event.inputs.commit_mode }}

      # OpenHands sandbox runtime (tools/browsing env)
      SANDBOX_RUNTIME_CONTAINER_IMAGE: docker.openhands.dev/openhands/runtime:0.60-nikolaik

      # Target repo for PRs
      TARGET_REPO: familiarizeptyltd/docs.familiarize.com

    steps:
      - name: Checkout workflows repo (public)
        uses: actions/checkout@v4

      - name: Checkout docs.familiarize.com (private)
        uses: actions/checkout@v4
        with:
          repository: familiarizeptyltd/docs.familiarize.com
          path: docs_repo
          token: ${{ secrets.REPO_TOKEN }}
          fetch-depth: 0
          submodules: true

      - name: Setup Python (for templating & gh)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install prompt tools
        run: |
          python -m pip install --upgrade pip
          pip install pygithub

      # ---------- Prompt: template -> .agent/rendered_prompt.md (or raw fallback) ----------
      - name: Resolve prompt (template → raw fallback)
        run: |
          set -euo pipefail

          TEMPLATE_PATH="${REPO_DIR}/${PROMPT_TEMPLATE}"
          PROFILES_NEW="${REPO_DIR}/prompts/country-profiles.json"
          PROFILES_OLD="${REPO_DIR}/prompts/country_profiles.json"
          RAW_PATH="${REPO_DIR}/${RAW_PROMPT_FILE}"

          if   [ -f "${PROFILES_NEW}" ]; then PROFILES_PATH="${PROFILES_NEW}";
          elif [ -f "${PROFILES_OLD}" ]; then PROFILES_PATH="${PROFILES_OLD}";
          else PROFILES_PATH=""; fi

          use_template=false
          if [ -n "${PROMPT_TEMPLATE}" ] && [ -f "${TEMPLATE_PATH}" ] && [ -n "${PROFILES_PATH}" ]; then
            use_template=true
          fi

          mkdir -p "${REPO_DIR}/.agent"

          if $use_template; then
            echo "Using template: ${TEMPLATE_PATH} (profile=${PROFILE_KEY}) with ${PROFILES_PATH}"
            python scripts/render_prompt.py \
              --profiles "${PROFILES_PATH}" \
              --profile-key "${PROFILE_KEY}" \
              --template   "${TEMPLATE_PATH}" \
              --output     "${REPO_DIR}/.agent/rendered_prompt.md"
            echo "PROMPT_FILE=.agent/rendered_prompt.md" >> "$GITHUB_ENV"
          else
            echo "Template/profiles missing. Falling back to RAW: ${RAW_PATH}"
            if [ ! -f "${RAW_PATH}" ]; then
              echo "❌ Missing inputs. Need either template+profiles or RAW."; exit 1
            fi
            cp -f "${RAW_PATH}" "${REPO_DIR}/.agent/rendered_prompt.md"
            echo "PROMPT_FILE=.agent/rendered_prompt.md" >> "$GITHUB_ENV"
          fi

      - name: Validate prompt path
        run: |
          set -euo pipefail
          test -f "${REPO_DIR}/${PROMPT_FILE}" || (echo "❌ Prompt not found: ${REPO_DIR}/${PROMPT_FILE}"; exit 1)

      - name: Configure Git user
        working-directory: ${{ env.REPO_DIR }}
        run: |
          git config user.name  "ci-agent"
          git config user.email "ci-agent@users.noreply.github.com"

      - name: Create/switch branch
        working-directory: ${{ env.REPO_DIR }}
        run: |
          set -euo pipefail
          if git rev-parse --verify "${TARGET_BRANCH}" >/dev/null 2>&1; then
            git checkout "${TARGET_BRANCH}"
          else
            git checkout -b "${TARGET_BRANCH}"
          fi

      - name: Pull sandbox runtime image (faster first run)
        run: docker pull "${SANDBOX_RUNTIME_CONTAINER_IMAGE}"

      - name: Pull OpenHands app image (CLI)
        run: docker pull docker.openhands.dev/openhands/openhands:0.60

      - name: Run OpenHands (docker headless; with Tavily search)
        env:
          # LLM secrets
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_COMPAT_API_KEY: ${{ secrets.OPENAI_COMPAT_API_KEY }}
          OPENAI_COMPAT_BASE_URL: ${{ secrets.OPENAI_COMPAT_BASE_URL }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}

          # Feature toggles (from workflow inputs)
          OH_ENABLE_BROWSING: ${{ env.ENABLE_BROWSING }}
          OH_ENABLE_SEARCH: ${{ env.ENABLE_SEARCH }}

          # Tavily (web search)
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}

          # Runtime image used by OpenHands runtime container
          SANDBOX_RUNTIME_CONTAINER_IMAGE: ${{ env.SANDBOX_RUNTIME_CONTAINER_IMAGE }}

          # Optional: reduce noise and cap run
          OPENHANDS_LOG_LEVEL: warning
          OPENHANDS_MAX_STEPS: "60"
          OPENHANDS_HARD_TIMEOUT_SEC: "1200"
        run: |
          set -euo pipefail

          # Map provider -> env that OpenHands reads
          case "${LLM_PROVIDER}" in
            openai)
              export LLM_PROVIDER="openai"
              export LLM_MODEL="${LLM_MODEL}"
              export LLM_API_KEY="${OPENAI_API_KEY}"
              ;;
            openai_compat)
              export LLM_PROVIDER="openai"
              export LLM_MODEL="${LLM_MODEL}"
              export LLM_API_KEY="${OPENAI_COMPAT_API_KEY}"
              export LLM_BASE_URL="${OPENAI_COMPAT_BASE_URL}"
              ;;
            grok)
              export LLM_PROVIDER="grok"
              export LLM_MODEL="${LLM_MODEL}"
              export LLM_API_KEY="${GROK_API_KEY}"
              ;;
            *)
              echo "Unsupported LLM provider: ${LLM_PROVIDER}"; exit 1;;
          esac

          # Optional browsing hint for agent
          [ "${OH_ENABLE_BROWSING}" = "true" ] && export AGENT_ENABLE_BROWSING=true || true

          # Ensure host dirs
          mkdir -p "${AGENT_LOG_DIR}" "${GITHUB_WORKSPACE}/.openhands"
          chmod 0777 "${GITHUB_WORKSPACE}/.openhands" || true

          # Verify prompt on host
          HOST_GOAL="${REPO_DIR}/${PROMPT_FILE}"
          if [ ! -f "${HOST_GOAL}" ]; then
            echo "❌ Missing goal on host: ${HOST_GOAL}"; exit 1
          fi
          echo "✅ Found goal on host: ${HOST_GOAL}"
          ls -la "${REPO_DIR}/.agent" || true

          # Absolute path used inside the container
          GOAL_ABS="/workspace/${PROMPT_FILE}"

          # --- Write OpenHands config.toml safely (no heredocs) ---
          OPENHANDS_CFG_DIR="${GITHUB_WORKSPACE}/${REPO_DIR}/.openhands"
          mkdir -p "${OPENHANDS_CFG_DIR}"
          CFG="${OPENHANDS_CFG_DIR}/config.toml"
          : > "$CFG"
          printf '%s\n' '[core]' >> "$CFG"
          printf '%s\n' 'agent = "CodeActAgent"' >> "$CFG"
          printf '%s\n' 'max_steps = 60' >> "$CFG"
          printf '%s\n' 'hard_timeout_sec = 1200' >> "$CFG"
          printf '%s\n' 'enable_browsing = true' >> "$CFG"
          printf '%s\n' 'enable_search = true' >> "$CFG"
          printf '%s\n' '' >> "$CFG"
          printf '%s\n' '[workspace]' >> "$CFG"
          printf '%s\n' 'root = "/workspace"' >> "$CFG"
          printf '%s\n' 'write_whitelist_globs = [' >> "$CFG"
          printf '%s\n' '  "content/**",' >> "$CFG"
          printf '%s\n' '  "themes/**",' >> "$CFG"
          printf '%s\n' '  ".agent/**",' >> "$CFG"
          printf '%s\n' '  ".env",' >> "$CFG"
          printf '%s\n' '  ".openhands/**",' >> "$CFG"
          printf '%s\n' '  "static/**",' >> "$CFG"
          printf '%s\n' '  "*.md"' >> "$CFG"
          printf '%s\n' ']' >> "$CFG"
          printf '%s\n' '' >> "$CFG"
          printf '%s\n' '[search]' >> "$CFG"
          printf '%s\n' 'provider = "tavily"' >> "$CFG"

          # Minimal MCP config to keep noise down
          echo "[]" > "${OPENHANDS_CFG_DIR}/mcp.json"

          # Runtime .env (keys loaded by some builds of the runtime)
          ENVFILE="${GITHUB_WORKSPACE}/${REPO_DIR}/.env"
          : > "$ENVFILE"
          [ -n "${TAVILY_API_KEY:-}" ] && printf 'TAVILY_API_KEY=%s\n' "${TAVILY_API_KEY}" >> "$ENVFILE"
          [ -n "${LLM_API_KEY:-}" ] && printf 'OPENAI_API_KEY=%s\n' "${LLM_API_KEY}" >> "$ENVFILE"
          [ -n "${LLM_BASE_URL:-}" ] && printf 'OPENAI_BASE_URL=%s\n' "${LLM_BASE_URL}" >> "$ENVFILE"

          # --- Inject a tiny runner script via base64 (avoids heredocs/printf pitfalls) ---
          mkdir -p "${GITHUB_WORKSPACE}/.openhands"
          RUNSH="${GITHUB_WORKSPACE}/.openhands/run.sh"
          : > "$RUNSH"

          SCRIPT_B64='IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLWV1byBwaXBlZmFpbApWRU5WX1BZPSIvYXBwLy52ZW52L2Jpbi9weXRob24iCjogIiR7R09BTF9BQlM6P0dPQUxfQUJTIHBmOiBHT0FMX0FCUyBub3Qgc2V0fSIKaWYgWyAhIC1mICIkR09BTF9BQlMiIF07IHRoZW4KICBlY2hvICJHb2FsIG5vdCB2aXNpYmxlOiAkR09BTF9BQlMiCiAgbHMgLWxhIC93b3Jrc3BhY2UgfHwgdHJ1ZQogIGxzIC1sYSAvd29ya3NwYWNlLy5hZ2VudCB8fCB0cnVlCiAgZXhpdCAxCmZpCmVjaG8gIkdvYWwgdnNpc2JsZTogJEdPQUxfQUJTIgoKIiRWRU5WX1BZIiAtbSBwaXAgSW5zdGFsbCAtLW5vLWNhY2hlLWRpciAtLWRpc2FibGUtcGlwLXZlcnNpb24tY2hlY2sgLXEgcHl0aG9uLWRvdGVudiB8fCB0cnVlCgpta2RpciAtcCAvd29ya3NwYWNlLy5hZ2VudApXUkFQUEVEPSIvd29ya3NwYWNlLy5hZ2VudC9fd3JhcHBlZF9nb2FsLm1kIgo6ID4gIiRXUkFQUEVEIgoKcHJpbnRmICclcyVcbicgJyMgU1lTVEVNIEVYRUNVVElPTiBESVJFQ1RJVkUnID4+ICIkV1JBUEVFRCIKcHJpbnRmICclcyVcbiIgIiA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICdZb3UgYXJlIENvZGVBY3RBZ2VudCBydW5uaW5nIGhlYWRsZXNzIGluIGEgR2l0IHJlcG8gYXQgL3dvcmtzcGFjZS4nID4+ICIkV1JBUEVFRCIKcHJpbnRmICclc1xuJyAnQWN0IGJ5IGNyZWF0aW5nL2VkaXRpbmcgZmlsZXMgZGlyZWN0bHkgdW5kZXIgL3dvcmtzcGFjZSAoc2VlIHdyaXRlX3doaXRlbGlzdF9nbG9icykuJyA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICIgPj4gIiRXUkFQUEVEIgpwcmludGYgJyVzXG4nICcjIyBSRVFVSVJFRCBBQ1RJT05TJyA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICcxKSBQbGFuIGJyaWVmbHkuJyA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICcyKSBDcmVhdGUgdGhlIGV4YWN0IG5ldyBNYXJrZG93biBmaWxlcyByZXF1ZXN0ZWQgKGRvIE5PVCBqdXN0IHByb3Bvc2UpLicgPj4gIiRXUkFQUEVEIgpwcmludGYgJyVzXG4nICczKSBWYWxpZGF0ZSBZQU1MIGZyb250IG1hdHRlciBhbmQgZGF0ZXMuJyA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICc0KSBTYXZlIGZpbGVzIHRvIHRoZSBleGFjdCByZXF1aXJlZCBwYXRocy4nID4+ICIkV1JBUEVFRCIKcHJpbnRmICclc1xuJyAnNSkgRmluaXNoIHdoZW4gZmlsZXMgYXJlIHdyaXR0ZW4uJyA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICIgPj4gIiRXUkFQUEVEIgpwcmludGYgJyVzXG4nICcjIyBHVUFSQU5URUVTJyA+PiAiJFdSQVBQRUQiCnByaW50ZiAnJXMlXG4nICLigqQgSWYgdGFncyBmaWxlIGlzIG1pc3NpbmcsIHBpY2sgMeKAkzIgYmVzdC1maXQgZXhpc3RpbmcgdGFncyBvciBza2lwIHdpdGggbm90ZTsgc3RpbGwgY3JlYXRlIGZpbGVzLicgPj4gIiRXUkFQUEVEIgpwcmludGYgJyVzXG4nICLigqQgSWYgYW55IGRpcmVjdG9yeSBpcyBtaXNzaW5nLCBjcmVhdGUgaXQgYW5kIGNvbnRpbnVlLicgPj4gIiRXUkFQUEVEIgpwcmludGYgJyVzXG4nICIgPj4gIiRXUkFQUEVEIgpwcmludGYgJyVzXG4nICdPUklHSU5BTCBHT0FMIEJFTElPVzonID4+ICIkV1JBUEVFRCIKcHJpbnRmICclc1xuJyAiID4+ICIkV1JBUEVFRCIKCmNhdCAiJEdPQUxfQUJTIiA+PiAiJFdSQVBQRUQiCgojIFJ1biBoZWFkbGVzcyB3aXRoIHRoZSB3cmFwcGVkIGdvYWwKZXhlYyAiJFZFTlZfUFkiIC1tIG9wZW5oYW5kcy5jb3JlLm1haW4gLWYgIiRXUkFQUEVEIiAtZCAiL3dvcmtzcGFjZSIK'

          printf '%s' "$SCRIPT_B64" | base64 -d > "$RUNSH"
          chmod +x "$RUNSH"

          # --- Launch OpenHands (app container) ---
          docker run --rm \
            --pull=always \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${GITHUB_WORKSPACE}/${REPO_DIR}:/workspace" \
            -v "${GITHUB_WORKSPACE}/${AGENT_LOG_DIR}:/logs" \
            -v "${GITHUB_WORKSPACE}/.openhands:/.openhands" \
            -w /workspace \
            --add-host host.docker.internal:host-gateway \
            -e SANDBOX_RUNTIME_CONTAINER_IMAGE="${SANDBOX_RUNTIME_CONTAINER_IMAGE}" \
            -e SANDBOX_USER_ID="$(id -u)" \
            -e LLM_PROVIDER="${LLM_PROVIDER}" \
            -e LLM_MODEL="${LLM_MODEL}" \
            -e LLM_API_KEY="${LLM_API_KEY}" \
            -e LLM_BASE_URL="${LLM_BASE_URL:-}" \
            -e AGENT_ENABLE_BROWSING="${AGENT_ENABLE_BROWSING:-}" \
            -e OH_ENABLE_SEARCH="${OH_ENABLE_SEARCH}" \
            -e TAVILY_API_KEY="${TAVILY_API_KEY:-}" \
            -e OPENHANDS_LOG_LEVEL="${OPENHANDS_LOG_LEVEL:-warning}" \
            -e OPENHANDS_MAX_STEPS="${OPENHANDS_MAX_STEPS:-60}" \
            -e OPENHANDS_HARD_TIMEOUT_SEC="${OPENHANDS_HARD_TIMEOUT_SEC:-1200}" \
            -e OPENHANDS_CONFIG="/workspace/.openhands/config.toml" \
            -e GOAL_ABS="${GOAL_ABS}" \
            docker.openhands.dev/openhands/openhands:0.60 \
              bash -lc "${GITHUB_WORKSPACE}/.openhands/run.sh"

      - name: Show agent outputs (if any)
        if: always()
        run: |
          echo "------- Agent output dir -------"
          ls -la "${AGENT_LOG_DIR}" || true

      - name: Commit changes (if any)
        working-directory: ${{ env.REPO_DIR }}
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "ℹ️ No changes to commit."
            exit 0
          fi
          git commit -m "OpenHands agent: apply changes from ${PROMPT_FILE}"

      - name: Push branch
        working-directory: ${{ env.REPO_DIR }}
        env:
          GIT_ASKPASS: /bin/echo
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          set -euo pipefail
          git push --set-upstream origin "${TARGET_BRANCH}"

      - name: Create PR (if requested)
        if: ${{ github.event.inputs.commit_mode == 'pr' }}
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          set -euo pipefail
          gh pr create \
            --repo "${TARGET_REPO}" \
            --head "${TARGET_BRANCH}" \
            --base "main" \
            --title "OpenHands: ${PROMPT_FILE}" \
            --body "$(printf "Automated changes by OpenHands agent.\n\nPrompt: \`%s\`\nBrowsing: \`%s\`, Search: \`%s\`\nModel: \`%s/%s\`" "${PROMPT_FILE}" "${ENABLE_BROWSING}" "${ENABLE_SEARCH}" "${LLM_PROVIDER}" "${LLM_MODEL}")" \
          || echo "ℹ️ PR may already exist or token lacks PR scope."

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openhands-run-${{ github.run_id }}
          path: ${{ env.AGENT_LOG_DIR }}/
          if-no-files-found: warn
