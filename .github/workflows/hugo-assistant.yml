name: Hugo Assistant

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt content or path to a prompt file in the target repository'
        required: true
        default: 'prompts/country-pages-prompt.txt'
        type: string
      prompt_is_file:
        description: 'Whether the prompt input is a file path (true) or direct content (false)'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'
      target_repo:
        description: 'Target repository to operate on (ORG/REPO format)'
        required: true
        default: 'familiarizeptyltd/docs.familiarize.com'
        type: string
      llm_provider:
        description: 'LLM provider (openai/grok/gpt-oss)'
        required: false
        default: 'openai'
        type: choice
        options:
          - openai
          - grok
          - gpt-oss
      llm_model:
        description: 'LLM model'
        required: false
        default: 'gpt-4o-mini'
      dry_run:
        description: 'Dry run mode (no changes made)'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      branch:
        description: 'Branch in target repo to create/switch'
        required: false
        default: 'ua/changes'
      commit_synth_assets:
        description: 'Commit/push synthesized tools/servers to assistant repo'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'
      prefer_unidiff:
        description: 'Prefer Python unidiff applier over git apply'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      no_fuzzy_unidiff:
        description: 'Disable fuzzy matching in unidiff fallback (strict only)'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'
      synth_servers_dir:
        description: 'Directory to write synthesized MCP servers (optional)'
        required: false
        default: ''
      synth_tools_dir:
        description: 'Directory to write synthesized in-process tools (optional)'
        required: false
        default: ''

jobs:
  execute-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout workflow repo (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'           # quoted to ensure string

      - name: Checkout Universal Assistant repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.ASSISTANT_REPO }}
          token: ${{ secrets.ASSISTANT_REPO_TOKEN }}
          path: assistant
          fetch-depth: '0'           # quoted
          submodules: 'recursive'    # string, not boolean

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo }}
          token: ${{ secrets.REPO_TOKEN }}
          path: target-repo
          fetch-depth: '0'           # quoted
          submodules: 'recursive'    # string, not boolean

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Universal Assistant (with MCP extras)
        run: |
          python -m pip install --upgrade pip
          pip install -e "assistant[mcp]"

      - name: Configure Git Identity (assistant repo)
        run: |
          cd assistant
          git config user.name "Universal AI Assistant"
          git config user.email "uaia@example.com"

      - name: Configure Git Identity (target repo)
        run: |
          cd target-repo
          git config user.name "Universal AI Assistant"
          git config user.email "uaia@example.com"

      - name: Execute Universal Assistant
        env:
          # Provider credentials mapping
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          XAI_API_KEY: ${{ secrets.GROK_API_KEY }}
          OA_COMPAT_API_KEY: ${{ secrets.GPT_OSS_API_KEY }}
          OA_COMPAT_BASE_URL: ${{ secrets.GPT_OSS_BASE_URL }}
          # Optional tool/search keys if your tools need them
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          GOOGLE_CUSTOM_SEARCH_API_KEY: ${{ secrets.GOOGLE_CUSTOM_SEARCH_API_KEY }}
          CUSTOM_SEARCH_ENGINE_ID: ${{ secrets.CUSTOM_SEARCH_ENGINE_ID }}
        shell: bash
        run: |
          set -euo pipefail

          # Provider â†’ model spec
          PROVIDER="${{ github.event.inputs.llm_provider }}"
          MODEL="${{ github.event.inputs.llm_model }}"
          if [ "$PROVIDER" = "openai" ]; then
            MODEL_SPEC="openai:${MODEL}"
          elif [ "$PROVIDER" = "grok" ]; then
            MODEL_SPEC="xai:${MODEL}"
          elif [ "$PROVIDER" = "gpt-oss" ]; then
            if [ -z "${OA_COMPAT_BASE_URL:-}" ]; then
              echo "OA_COMPAT_BASE_URL is not set; configure GPT_OSS_BASE_URL secret."
              exit 1
            fi
            MODEL_SPEC="compat:${OA_COMPAT_BASE_URL}:${MODEL}"
          else
            echo "Unknown provider '${PROVIDER}'"
            exit 1
          fi

          # Prompt flags
          if [ "${{ github.event.inputs.prompt_is_file }}" = "true" ]; then
            PROMPT_PATH="${{ github.workspace }}/target-repo/${{ github.event.inputs.prompt }}"
            if [ ! -f "$PROMPT_PATH" ]; then
              echo "Prompt file '$PROMPT_PATH' not found"
              exit 1
            fi
            PROMPT_FLAG=(--prompt-file "$PROMPT_PATH")
          else
            PROMPT_FLAG=(--prompt "${{ github.event.inputs.prompt }}")
          fi

          # Optional flags
          DRY_RUN_FLAG=()
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG=(--dry-run)
          fi

          SYNTH_FLAGS=()
          if [ "${{ github.event.inputs.commit_synth_assets }}" = "true" ]; then
            # Direct synthesized output into the assistant repo so commits/pushes land there
            SYNTH_FLAGS=(--commit-synth-tools --push-synth-tools --synth-branch ua/tools \
                         --synth-servers-dir "${{ github.workspace }}/assistant" \
                         --synth-tools-dir "${{ github.workspace }}/assistant/mcp_servers")
          fi

          PATCH_FLAGS=()
          if [ "${{ github.event.inputs.prefer_unidiff }}" = "true" ]; then
            PATCH_FLAGS+=("--prefer-unidiff")
          fi
          if [ "${{ github.event.inputs.no_fuzzy_unidiff }}" = "true" ]; then
            PATCH_FLAGS+=("--no-fuzzy-unidiff")
          fi

          # Optional override flags from inputs
          SERVERS_DIR_FLAG=()
          if [ -n "${{ github.event.inputs.synth_servers_dir }}" ]; then
            SERVERS_DIR_FLAG=(--synth-servers-dir "${{ github.event.inputs.synth_servers_dir }}")
          fi
          TOOLS_DIR_FLAG=()
          if [ -n "${{ github.event.inputs.synth_tools_dir }}" ]; then
            TOOLS_DIR_FLAG=(--synth-tools-dir "${{ github.event.inputs.synth_tools_dir }}")
          fi

          # Run the assistant using assistant/ua.yml config
          ua run \
            --target "${{ github.workspace }}/target-repo" \
            "${PROMPT_FLAG[@]}" \
            --model "${MODEL_SPEC}" \
            --branch "${{ github.event.inputs.branch }}" \
            --config "${{ github.workspace }}/assistant/ua.yml" \
            "${DRY_RUN_FLAG[@]}" \
            "${SYNTH_FLAGS[@]}" \
            "${PATCH_FLAGS[@]}" \
            "${SERVERS_DIR_FLAG[@]}" \
            "${TOOLS_DIR_FLAG[@]}"

      - name: Upload execution artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ua-execution-${{ github.run_id }}
          path: |
            target-repo/.execution_report.json
          if-no-files-found: ignore
          retention-days: 30
