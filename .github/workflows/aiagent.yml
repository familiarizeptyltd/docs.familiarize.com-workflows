name: aiagent (main)

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Prompt content or path to a prompt file in the target repository'
        required: true
        default: 'prompts/switzerland-pages.md'
        type: string
      prompt_is_file:
        description: 'Whether the prompt input is a file path (true) or direct content (false)'
        required: false
        type: boolean
        default: true
      target_repo:
        description: 'Target repository to operate on (ORG/REPO format)'
        required: true
        default: 'familiarize/docs.familiarize.com'
        type: string
      llm_provider:
        description: 'LLM provider (openai/grok/professionalize)'
        required: false
        default: 'professionalize'
        type: choice
        options:
        - openai
        - grok
        - professionalize
      llm_model:
        description: 'LLM model'
        required: false
        default: 'gpt-oss'      

jobs:
  execute-task:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout public workflow repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout aiAgent repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.AI_AGENT_REPO }}
          token: ${{ secrets.AI_AGENT_REPO_TOKEN }}
          path: aiagent
          fetch-depth: 0

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.REPO }}
          token: ${{ secrets.REPO_TOKEN }}
          path: target-repo
          fetch-depth: 0
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r aiagent/requirements.txt

      - name: Setup aiAgent configuration
        run: |
          # Copy config if it exists in repo
          if [ -f "aiagent/config.yaml" ]; then
            mkdir -p /home/runner/.aiagent
            cp aiagent/config.yaml /home/runner/.aiagent/config.yaml
            echo "✓ Copied custom config.yaml"
          else
            echo "⚠ No custom config.yaml found, will use defaults"
          fi

      - name: Verify GitHub CLI
        run: |
          gh --version

      - name: Configure Git Identity
        run: |
          cd target-repo
          git config user.name "aiAgent"
          git config user.email "aiagent@aiagent.com"
          cd ..

      - name: Execute aiAgent
        env:
          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GPT_OSS_API_KEY: ${{ secrets.GPT_OSS_API_KEY }}
          GPT_OSS_BASE_URL: ${{ secrets.GPT_OSS_BASE_URL }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          GOOGLE_CUSTOM_SEARCH_API_KEY: ${{ secrets.GOOGLE_CUSTOM_SEARCH_API_KEY }}
          CUSTOM_SEARCH_ENGINE_ID: ${{ secrets.CUSTOM_SEARCH_ENGINE_ID }}
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          set -e
          
          # Get absolute workspace path
          WORKSPACE_PATH="$(cd ../target-repo && pwd)"
          echo "Workspace: $WORKSPACE_PATH"
          
          # Build aiAgent command
          AIAGENT_CMD="python -m aiagent.cli.main run"
          
          # Handle prompt (file or direct content)
          if [ "${{ github.event.inputs.prompt_is_file }}" = "true" ]; then
            # File prompt
            PROMPT_FILE="$WORKSPACE_PATH/${{ github.event.inputs.prompt }}"
            
            # Verify file exists
            if [ ! -f "$PROMPT_FILE" ]; then
              echo "Error: Prompt file '$PROMPT_FILE' does not exist."
              echo "Available files in prompts/:"
              ls -la "$WORKSPACE_PATH/prompts/" || true
              exit 1
            fi
            
            echo "Prompt file: $PROMPT_FILE"
            AIAGENT_CMD="$AIAGENT_CMD --file \"$PROMPT_FILE\""
          else
            # Direct content prompt
            echo "Using direct prompt content"
            AIAGENT_CMD="$AIAGENT_CMD '${{ github.event.inputs.prompt }}'"
          fi
          
          # Add common parameters
          AIAGENT_CMD="$AIAGENT_CMD --workspace \"$WORKSPACE_PATH\""
          AIAGENT_CMD="$AIAGENT_CMD --auto"
          AIAGENT_CMD="$AIAGENT_CMD --mode orchestrator"
          AIAGENT_CMD="$AIAGENT_CMD --provider ${{ github.event.inputs.llm_provider }}"
          
          # Execute
          echo "Executing: $AIAGENT_CMD"
          eval $AIAGENT_CMD
          
        working-directory: aiagent

      - name: Check for aiagent Updates
        id: check_updates
        run: |
          cd aiagent
          if [ -f "generated_tools.json" ] || [ -f "new_servers.py" ]; then
            echo "updates_needed=true" >> $GITHUB_OUTPUT
            echo "aiagent generated new tools/servers during execution"
          else
            echo "updates_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update aiagent Repository (if needed)
        if: steps.check_updates.outputs.updates_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.AI_AGENT_REPO_TOKEN }}
        run: |
          cd aiagent
          
          # Configure git for aiagent repo updates
          git config user.name "aiAgent"
          git config user.email "aiagent@familiarize.com"
          
          # Add generated files
          git add generated_tools.json new_servers.py 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No new tools/servers to commit"
          else
            # Commit and push updates
            git commit -m "feat: Add dynamically generated tools and servers
            
            Generated during task execution:
            - New MCP servers for task requirements
            - Runtime-generated tools
            - Auto-generated by aiAgent"
            
            git push origin main
            echo "aiagent repository updated with new tools/servers"
          fi

      - name: Upload execution artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aiagent-execution-${{ github.run_id }}
          path: |
            target-repo/aiagent-run-*.log
            target-repo/.execution_report.json
            aiagent/generated_tools.json
            aiagent/new_servers.py
          if-no-files-found: ignore
          retention-days: 30
